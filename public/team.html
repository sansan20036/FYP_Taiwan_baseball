<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ProBall Analytics | 球隊</title>

    <!-- 與首頁一致的字型、圖示與主樣式 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" href="https://fav.farm/⚾">
    <link rel="stylesheet" href="app.css" />
  </head>

  <body class="theme-light baseball-theme">
    <!-- 啟動畫面 / 背景 / 捲動進度條（與首頁一致，可由 app.js 控制顯示/隱藏） -->
    <div id="splash" class="splash" aria-label="啟動畫面" aria-live="polite" hidden></div>
    <div class="bg-canvas" aria-hidden="true"></div>
    <div class="scroll-progress" aria-hidden="true"><span></span></div>

    <!-- 導覽列（同步首頁結構與樣式） -->
    <header class="navbar" role="banner">
      <div class="navbar__inner container">
        <a href="app.html" class="navbar__brand" aria-label="回到首頁">
          <i class="ri-baseball-line"></i><span>ProBall Analytics</span>
        </a>
        <nav class="navbar__nav" role="navigation" aria-label="主選單">
          <a class="nav__link" href="app.html#home">首頁</a>
          <a class="nav__link" href="matches.html">賽事</a>
          <a class="nav__link is-active" href="team.html" aria-current="page">球隊</a>
          <a class="nav__link" href="players.html">球員</a>
          <a class="nav__link" href="models.html">模型預測</a>
          <a class="nav__link" href="personalize.html">個人化</a>
        </nav>
        <div class="navbar__tools">
          <div class="search">
            <i class="ri-search-2-line" aria-hidden="true"></i>
            <input id="teamSearchInput" type="search" placeholder="搜尋球隊 / 主場 / 教練" aria-label="搜尋球隊或主場" />
            <div id="searchSuggest" class="suggest" hidden></div>
          </div>
          <button class="icon-btn" aria-label="通知">
            <i class="ri-notification-3-line"></i>
          </button>
          <button id="themeToggleBtn" type="button" class="icon-btn theme-toggle" aria-label="切換主題" role="switch" aria-checked="false" data-theme-toggle>
            <i class="ri-sun-line"></i>
          </button>
          <button class="avatar" aria-label="使用者選單">
            <img src="https://images.unsplash.com/photo-1607746882042-944635dfe10e?q=80&w=200&auto=format&fit=crop" alt="使用者頭像" />
          </button>
        </div>
      </div>
    </header>

    <main id="teamsPage" class="main">
      <section class="container" aria-labelledby="teamsTitle">
        <div class="section-header">
          <h2 id="teamsTitle"><i class="ri-team-line"></i> 球隊一覽</h2>
          <div class="section-actions">
            <button id="btnCopyLink" class="chip" title="複製目前篩選連結"><i class="ri-links-line"></i> 複製連結</button>
            <button id="btnClear" class="chip" title="清除搜尋"><i class="ri-eraser-line"></i> 清除</button>
          </div>
        </div>

        <!-- 統計小摘要 -->
        <div class="info-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:16px">
          <div class="info-card">
            <div class="label"><i class="ri-database-2-line"></i> 載入資料</div>
            <div class="value"><span id="countLoaded">0</span> 隊</div>
          </div>
          <div class="info-card">
            <div class="label"><i class="ri-filter-3-line"></i> 篩選結果</div>
            <div class="value"><span id="countFiltered">0</span> 隊</div>
          </div>
        </div>

        <!-- 球隊格狀清單 -->
        <div id="teamsGrid" class="team-grid container" style="display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(320px,1fr))" aria-live="polite"></div>
        <div id="emptyView" class="empty" style="display:none">沒有符合條件的球隊</div>
      </section>
    </main>

    <!-- 頁尾（同步首頁） -->
    <footer class="footer" role="contentinfo">
      <div class="container footer__inner">
        <div class="footer__brand"><i class="ri-baseball-line"></i><span>ProBall Analytics</span></div>
        <nav class="footer__nav" aria-label="頁尾連結">
          <a href="#contact">聯絡我們</a>
          <a href="#terms">使用條款</a>
          <a href="#privacy">隱私政策</a>
          <a href="#api">API 申請</a>
          <a href="#social">社群連結</a>
        </nav>
        <div class="footer__copy">© <span id="year"></span> ProBall Analytics</div>
      </div>
    </footer>

    <!-- 回頂端 / 聊天（同步首頁） -->
    <button id="scrollTopBtn" class="fab" aria-label="回到頂端" hidden><i class="ri-arrow-up-line"></i></button>
    <button id="chatFab" class="fab chat-fab" aria-label="開啟 AI 助理"><i class="ri-robot-2-line"></i></button>
    <section id="chatbot" class="chatbot" aria-label="AI 聊天助理" hidden>
      <header class="chat-header">
        <div class="chat-title"><i class="ri-robot-2-line"></i> ProBall AI 助理</div>
        <div class="chat-actions"><button id="chatClose" class="icon-btn" aria-label="清除對話"><i class="ri-close-line"></i></button></div>
      </header>
      <div id="chatBody" class="chat-body" role="log" aria-live="polite"></div>
      <div class="chat-input">
        <input id="chatText" type="text" placeholder="輸入訊息，例如：今天有哪些賽事？" aria-label="輸入訊息" />
        <button id="chatSend" class="btn btn-accent" aria-label="送出"><i class="ri-send-plane-2-line"></i></button>
      </div>
    </section>

    <!-- Toast（同步首頁） -->
    <div id="themeToast" class="toast" aria-live="polite" hidden></div>
    <div id="homeToast" class="toast" role="status" aria-live="polite" hidden></div>

    <!-- 頁面專屬腳本：載入 teams.json + 搜尋/建議 + 快捷鍵 -->
    <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const grid = $('#teamsGrid');
      const emptyView = $('#emptyView');
      const input = $('#teamSearchInput');
      const suggest = $('#searchSuggest');
      const countLoaded = $('#countLoaded');
      const countFiltered = $('#countFiltered');
      const themeBtn = $('#themeToggleBtn');
      const toast = $('#homeToast');

      const state = { data: [], filtered: [], keyword: '' };

      // 讀 JSON
      async function loadTeams(){
        const res = await fetch('teams.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('無法載入 teams.json');
        return await res.json();
      }

      // 渲染一張卡片（沿用首頁卡片風格）
      function renderCard(t){
        const el = document.createElement('article');
        el.className = 'team-card';
        el.id = t.code;

        // recent badges & stats 可後續擴充；先呈現核心資料
        el.innerHTML = `
          <img class="team-logo" src="${t.logo}" alt="${t.nameZh} 隊徽" loading="lazy" decoding="async" referrerpolicy="no-referrer"/>
          <h3 class="team-name">${t.nameZh} <span class="muted">${t.nameEn||''}</span></h3>
          <p class="record">主場：${t.ballpark||'—'}</p>
          <div class="standing">總教練：${t.manager||'—'}　領隊：${t.leader||'—'}</div>

          <ul class="team-stats">
            <li><span>投手</span><strong>${(t.players?.['投手']||[]).length}</strong></li>
            <li><span>捕手</span><strong>${(t.players?.['捕手']||[]).length}</strong></li>
            <li><span>野手</span><strong>${
              (t.players?.['內野手']||[]).length + (t.players?.['外野手']||[]).length
            }</strong></li>
          </ul>

          <div class="team-actions">
            ${t.website ? `<a class="btn btn-outline" href="${t.website}" target="_blank" rel="noopener"><i class="ri-external-link-line"></i> 官方網站</a>` : ''}
            <button class="btn btn-accent" data-open="${t.code}"><i class="ri-eye-line"></i> 展開詳情</button>
          </div>

          <details class="mt-3">
            <summary>詳細資料</summary>
            <div class="more mt-2">
              ${t.history ? `<p class="muted">沿革：${t.history}</p>` : ''}
              ${renderCoachTable(t.coaches||[])}
              ${renderPlayers(t.players||{})}
              ${t.address || t.phone || t.email ? `
                <div class="contact">
                  <p class="muted">地址：${t.address||'—'}</p>
                  <p class="muted">電話：${t.phone||'—'}；傳真：${t.fax||'—'}；Email：${t.email||'—'}</p>
                </div>` : '' }
            </div>
          </details>
        `;
        // 展開按鈕
        el.querySelector('[data-open]')?.addEventListener('click', () => {
          el.querySelector('details')?.setAttribute('open','');
          el.scrollIntoView({ behavior:'smooth', block:'start' });
        });
        return el;
      }

      function renderCoachTable(coaches){
        if(!coaches.length) return `<div class="muted">（無教練資料）</div>`;
        const head = `<thead><tr><th>職稱</th><th>姓名</th><th>背號</th></tr></thead>`;
        const rows = coaches.map(c=>`<tr><td>${c[0]||''}</td><td>${c[1]||''}</td><td>${c[2]||''}</td></tr>`).join('');
        return `<div class="mt-2">
          <div class="label"><i class="ri-user-star-line"></i> 教練團</div>
          <table class="min-w-full">${head}<tbody>${rows}</tbody></table>
        </div>`;
      }

      function renderPlayers(players){
        const groups = Object.keys(players||{});
        if(!groups.length) return `<div class="muted">（無球員資料）</div>`;
        return groups.map(g=>{
          const list = players[g]||[];
          const hasPos = list.some(p=>p[2]);
          const head = `<thead><tr><th>背號</th><th>姓名</th>${hasPos?'<th>守位</th>':''}</tr></thead>`;
          const rows = list.map(p=>`<tr><td>${p[0]}</td><td>${p[1]}</td>${hasPos?`<td>${p[2]||''}</td>`:''}</tr>`).join('');
          return `<details class="mt-2" ${g==='投手'?'open':''}>
            <summary><strong>${g}</strong>（${list.length} 人）</summary>
            <table class="min-w-full mt-1">${head}<tbody>${rows}</tbody></table>
          </details>`;
        }).join('');
      }

      function applyDeepLink(){
        const u = new URL(location.href);
        const key = u.searchParams.get('team') || location.hash.replace('#','');
        if(!key) return;
        const target = state.filtered.find(t=>t.code === key);
        if(!target) return;
        const card = document.getElementById(target.code);
        card?.querySelector('details')?.setAttribute('open','');
        card?.classList.add('is-target');
        const y = card.getBoundingClientRect().top + window.scrollY - 72;
        window.scrollTo({ top: y, behavior: 'smooth' });
        document.title = `${target.nameZh} | ProBall Analytics`;
      }

      function filterData(k){
        const kw = (k||'').trim().toLowerCase();
        state.keyword = kw;
        if(!kw) return state.data.slice();
        return state.data.filter(t=>{
          const hay = [
            t.code, t.nameZh, t.nameEn, t.ballpark, t.leader, t.manager, t.history
          ].filter(Boolean).join(' ').toLowerCase();
          return hay.includes(kw);
        });
      }

      function renderList(list){
        grid.innerHTML = '';
        if(!list.length){ emptyView.style.display=''; countFiltered.textContent='0'; return; }
        emptyView.style.display='none';
        list.forEach(t=>grid.appendChild(renderCard(t)));
        countFiltered.textContent = String(list.length);
      }

      function buildSuggest(list, kw){
        if(!kw){ suggest.hidden = true; suggest.innerHTML=''; return; }
        const items = list.slice(0,8).map(t=>`
          <button class="suggest__item" data-jump="${t.code}">
            <i class="ri-team-line"></i>
            <span class="text">${t.nameZh}</span>
            <span class="sub">${t.nameEn||''} · ${t.code}</span>
          </button>`).join('');
        suggest.innerHTML = items || `<div class="suggest__empty">找不到「${kw}」</div>`;
        suggest.hidden = false;
        suggest.querySelectorAll('[data-jump]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const code = btn.getAttribute('data-jump');
            location.href = `?team=${encodeURIComponent(code)}#${encodeURIComponent(code)}`;
          });
        });
      }

      function showToast(msg){
        if(!toast) return;
        toast.textContent = msg;
        toast.hidden = false;
        clearTimeout(showToast.t); showToast.t = setTimeout(()=>toast.hidden = true, 1800);
      }

      // 初始化
      (async function init(){
        try{
          state.data = await loadTeams();
          countLoaded.textContent = String(state.data.length);
          state.filtered = state.data.slice();
          renderList(state.filtered);
          applyDeepLink();
        }catch(err){
          console.error(err);
          grid.innerHTML = '<div class="empty">無法讀取 <code>teams.json</code></div>';
        }
      })();

      // 搜尋框交互
      input.addEventListener('input', ()=>{
        state.filtered = filterData(input.value);
        renderList(state.filtered);
        buildSuggest(state.filtered, input.value.trim());
      });
      input.addEventListener('focus', ()=>{
        if(input.value.trim()) buildSuggest(state.filtered, input.value.trim());
      });
      document.addEventListener('click', (e)=>{
        if(!suggest.contains(e.target) && e.target !== input){ suggest.hidden = true; }
      });

      // 功能按鈕
      $('#btnClear')?.addEventListener('click', ()=>{ input.value=''; input.dispatchEvent(new Event('input')); input.focus(); });
      $('#btnCopyLink')?.addEventListener('click', ()=>{
        const url = new URL(location.href);
        if(state.keyword){
          url.searchParams.set('q', state.keyword);
        }else{
          url.searchParams.delete('q');
        }
        navigator.clipboard.writeText(url.toString()).then(()=>showToast('已複製目前篩選連結')).catch(()=>{});
      });

      // 快捷鍵（與首頁一致風格）
      // / 或 Ctrl+K：聚焦搜尋；t：切換主題；g t：前往球隊、g h：首頁、g m：賽事、g p：球員
      let gPressed = false;
      document.addEventListener('keydown', (e)=>{
        const tag = (e.target.tagName||'').toLowerCase();
        const isTyping = tag === 'input' || tag === 'textarea' || e.target.isContentEditable;

        if((e.key === '/' || (e.key.toLowerCase()==='k' && (e.ctrlKey||e.metaKey))) && !isTyping){
          e.preventDefault(); input.focus(); input.select(); return;
        }
        if(e.key.toLowerCase()==='t' && !isTyping && !e.altKey && !e.ctrlKey && !e.metaKey){
          if(gPressed){ location.href = 'team.html'; gPressed=false; return; }
          // 單鍵 t：切換主題
          themeBtn?.click();
        }
        if(e.key.toLowerCase()==='g' && !isTyping){ gPressed = true; setTimeout(()=>gPressed=false, 800); }
        if(e.key.toLowerCase()==='h' && gPressed){ location.href = 'app.html#home'; gPressed=false; }
        if(e.key.toLowerCase()==='m' && gPressed){ location.href = 'matches.html'; gPressed=false; }
        if(e.key.toLowerCase()==='p' && gPressed){ location.href = 'players.html'; gPressed=false; }
        if(e.key === 'Enter' && document.activeElement === input && !suggest.hidden){
          const first = suggest.querySelector('[data-jump]');
          if(first){ first.click(); }
        }
      });

      // 若網址帶 ?q= 關鍵字，初始化時套用
      (function initQueryFromURL(){
        const url = new URL(location.href);
        const q = url.searchParams.get('q');
        if(q){ input.value = q; input.dispatchEvent(new Event('input')); }
      })();
    })();
    </script>

    <!-- 與首頁共用的互動腳本（主題切換、滾動特效、聊天面板等） -->
    <script src="app.js"></script>
  </body>
</html>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>球員比較 | ProBall Analytics</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-5xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-bold mb-6">球員數據比較</h1>
    <p class="text-gray-600 mb-4">從網址參數自動偵測第一位球員，再搜尋第二位球員進行比較。</p>

    <div id="playerInfo" class="mb-8 p-4 bg-white rounded shadow">
      <h2 class="text-2xl font-semibold mb-2" id="player1Name"></h2>
      <p id="player1Details" class="text-gray-600"></p>
    </div>

    <div class="mb-8">
      <label for="searchInput" class="block font-semibold mb-2">搜尋比較的球員：</label>
      <input id="searchInput" type="text" placeholder="輸入球員名字..." 
             class="w-full p-3 border rounded shadow-sm focus:ring focus:ring-blue-300" />
      <div id="searchResults" class="mt-3 bg-white rounded shadow divide-y"></div>
    </div>

    <div id="compareSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">比較結果</h2>
      <canvas id="compareChart" height="120"></canvas>
    </div>
  </div>

  <script>
  // === Step 1. Get player from URL ===
  const urlParams = new URLSearchParams(window.location.search);
  const playerName = urlParams.get("player");

  const player1NameEl = document.getElementById("player1Name");
  const player1DetailsEl = document.getElementById("player1Details");
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  const compareSection = document.getElementById("compareSection");
  const compareCanvas = document.getElementById("compareChart");

  let allPlayers = [];
  let player1 = null, player2 = null;
  let chart = null;

  // === Step 2. Load JSON file ===
  async function loadPlayers() {
    const res = await fetch("members_details.json");
    const data = await res.json();
    if (Array.isArray(data)) allPlayers = data;
    else {
      for (const key in data) allPlayers.push(data[key]);
    }
    if (playerName) {
      player1 = allPlayers.find(p => (p.name || p['姓名']) === playerName);
      if (player1) displayPlayer1(player1);
    }
  }

  // === Step 3. Display detected player ===
  function displayPlayer1(p) {
    player1NameEl.textContent = p.name || p['姓名'];
    player1DetailsEl.textContent = `背號：${p.number || p['背號'] || '-'}　位置：${p.position || p['位置'] || '-'}`;
  }

  // === Step 4. Search for another player ===
  searchInput.addEventListener("input", e => {
    const keyword = e.target.value.trim();
    searchResults.innerHTML = "";
    if (!keyword) return;

    const matched = allPlayers.filter(p => 
      (p.name || p['姓名']).includes(keyword)
    ).slice(0, 10);

    matched.forEach(p => {
      const div = document.createElement("div");
      div.className = "p-3 hover:bg-blue-100 cursor-pointer";
      div.textContent = p.name || p['姓名'];
      div.onclick = () => selectPlayer2(p);
      searchResults.appendChild(div);
    });
  });

  // === Step 5. Select player2 & draw chart ===
  function selectPlayer2(p2) {
    player2 = p2;
    searchResults.innerHTML = "";
    searchInput.value = player2.name || player2['姓名'];
    compareSection.classList.remove("hidden");
    drawChart();
  }

  // === Step 6. Draw comparison chart ===
  function drawChart() {
    const stats = ["AVG", "H", "HR", "RBI", "OBP"];
    const labelMap = {
      AVG: "打擊率",
      H: "安打",
      HR: "全壘打",
      RBI: "打點",
      OBP: "上壘率"
    };

    const p1Data = stats.map(s => parseFloat(player1[s] || player1[s.toLowerCase()] || 0));
    const p2Data = stats.map(s => parseFloat(player2[s] || player2[s.toLowerCase()] || 0));

    if (chart) chart.destroy();
    chart = new Chart(compareCanvas, {
      type: "radar",
      data: {
        labels: stats.map(s => labelMap[s]),
        datasets: [
          {
            label: player1.name || player1['姓名'],
            data: p1Data,
            borderColor: "rgba(37, 99, 235, 0.8)",
            backgroundColor: "rgba(37, 99, 235, 0.2)"
          },
          {
            label: player2.name || player2['姓名'],
            data: p2Data,
            borderColor: "rgba(239, 68, 68, 0.8)",
            backgroundColor: "rgba(239, 68, 68, 0.2)"
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: { ticks: { display: false } }
        }
      }
    });
  }

  loadPlayers();
  </script>

<!-- ProBall Chatbot (auto-inject widget) -->
<script src="chatbot.js"></script>
</body>
</html>
